<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Xerox Admin Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { background:#f4f6f8; }
  .container { margin-top:34px; max-width:1100px; }
  .card { border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
  .logout { position:fixed; right:20px; top:18px; }
  h1 { text-align:center; color:#0d6efd; margin-bottom:18px; }
  .small-note { font-size:0.9rem; color:#666; }
</style>
</head>
<body>
  <div class="container">
    <a href="/logout" class="btn btn-danger logout">Logout</a>
    <h1>ðŸ“Š Xerox Admin Dashboard</h1>

    <!-- top cards -->
    <div class="row g-3">
      <div class="col-md-2"><div class="card p-3 text-center"><h6>Total Orders</h6><h3 id="total">0</h3></div></div>
      <div class="col-md-2"><div class="card p-3 text-center"><h6>Pending</h6><h3 id="pending">0</h3></div></div>
      <div class="col-md-2"><div class="card p-3 text-center"><h6>Completed</h6><h3 id="completed">0</h3></div></div>
      <div class="col-md-2"><div class="card p-3 text-center"><h6>Online</h6><h3 id="online">0</h3></div></div>
      <div class="col-md-2"><div class="card p-3 text-center"><h6>Cash</h6><h3 id="cash">0</h3></div></div>
      <div class="col-md-2"><div class="card p-3 text-center"><h6>Total Earned (â‚¹)</h6><h3 id="totalEarned">0</h3></div></div>
    </div>

    <!-- filter controls -->
    <div class="row align-items-center mt-4 g-3">
      <div class="col-md-4">
        <select id="timeFilter" class="form-select">
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
        </select>
      </div>
      <div class="col-md-4">
        <button id="viewOrders" class="btn btn-dark w-100" onclick="location.href='/orders'">View Orders</button>
      </div>
      <div class="col-md-4">
        <button id="resetDbBtn" class="btn btn-outline-danger w-100">Reset Database (Clear Orders)</button>
      </div>
    </div>

    <!-- filtered cards -->
    <div class="row g-3 mt-3">
      <div class="col-md-3"><div class="card p-3 text-center"><h6>Filter: <span id="filterLabel">Today</span></h6><h3 id="filterPeriod">â€”</h3></div></div>
      <div class="col-md-3"><div class="card p-3 text-center"><h6>Cash Count</h6><h3 id="filterCashCount">0</h3><p class="small-note">â‚¹<span id="filterCashTotal">0</span></p></div></div>
      <div class="col-md-3"><div class="card p-3 text-center"><h6>Online Count</h6><h3 id="filterOnlineCount">0</h3><p class="small-note">â‚¹<span id="filterOnlineTotal">0</span></p></div></div>
      <div class="col-md-3"><div class="card p-3 text-center"><h6>Updated</h6><p id="lastUpdated" class="small-note">â€”</p></div></div>
    </div>

    <!-- weekly chart -->
    <div class="card p-3 mt-4">
      <h5>Last 7 Days â€” Payments (Count)</h5>
      <canvas id="weeklyChart" height="90"></canvas>
    </div>
  </div>

<script>
/* helper */
function el(id){ return document.getElementById(id); }

async function fetchJson(url, opts){ const res = await fetch(url, opts); if (!res.ok) throw await res.json(); return res.json(); }

/* Load main stats */
async function loadStats(){
  try {
    const stats = await fetchJson('/api/stats');
    el('total').innerText = stats.total;
    el('pending').innerText = stats.pending;
    el('completed').innerText = stats.completed;
    el('online').innerText = stats.online;
    el('cash').innerText = stats.cash;
    el('totalEarned').innerText = stats.totalEarned || 0;
    el('lastUpdated').innerText = new Date().toLocaleString();
    // update chart data placeholders (chart instance will update itself)
    if (window.chartInstance) {
      window.chartInstance.data.datasets[0].data = [stats.pending, stats.completed];
      window.chartInstance.data.datasets[1].data = [stats.online, stats.cash];
      window.chartInstance.update();
    }
  } catch (err) {
    console.error(err);
  }
}

/* Load filtered payments (today/week/month) */
async function loadFiltered(){
  try {
    const filter = el('timeFilter').value;
    el('filterLabel').innerText = filter === 'today' ? 'Today' : filter === 'week' ? 'This Week' : 'This Month';
    const data = await fetchJson(`/api/orders-filtered?filter=${filter}`);
    el('filterCashCount').innerText = data.cashCount;
    el('filterCashTotal').innerText = data.cashTotal || 0;
    el('filterOnlineCount').innerText = data.onlineCount;
    el('filterOnlineTotal').innerText = data.onlineTotal || 0;
  } catch (err) {
    console.error(err);
  }
}

/* Build weekly chart (last 7 days using /api/daily-payments?date=YYYY-MM-DD) */
async function loadWeeklyChart(){
  try {
    const labels = [], cash = [], online = [];
    for (let i=6;i>=0;i--){
      const d = new Date(); d.setDate(d.getDate()-i);
      const yyyy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
      const dateStr = `${yyyy}-${mm}-${dd}`;
      labels.push(`${dd}/${mm}`);
      const res = await fetch(`/api/daily-payments?date=${dateStr}`);
      if (!res.ok) { cash.push(0); online.push(0); continue; }
      const json = await res.json();
      cash.push(json.cashCount || 0);
      online.push(json.onlineCount || 0);
    }

    const ctx = document.getElementById('weeklyChart').getContext('2d');
    window.chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label:'Cash', data: cash, borderColor:'#28a745', backgroundColor:'rgba(40,167,69,0.08)', tension:0.3 },
          { label:'Online', data: online, borderColor:'#0d6efd', backgroundColor:'rgba(13,110,253,0.08)', tension:0.3 }
        ]
      },
      options:{ responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true } } }
    });

  } catch (err) {
    console.error('Weekly chart load error', err);
  }
}

/* Reset DB button (admin-only) */
document.getElementById('resetDbBtn').addEventListener('click', async () => {
  if (!confirm('This will delete ALL orders and cannot be undone. Continue?')) return;
  try {
    const res = await fetch('/api/reset-db', { method: 'POST' });
    const json = await res.json();
    alert(json.message || 'Reset done');
    loadAll();
  } catch (err) {
    alert(err.error || 'Reset failed');
  }
});

/* orchestrator */
async function loadAll(){
  await loadStats();
  await loadFiltered();
  await loadWeeklyChart();
}
document.getElementById('timeFilter').addEventListener('change', loadFiltered);

/* initial + auto-refresh */
loadAll();
setInterval(loadAll, 8000);
</script>
</body>
</html>
